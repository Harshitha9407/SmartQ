<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartQ - Join Queue</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 400px; width: 90%; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .brand-name { font-size: 32px; font-weight: bold; color: #4a90ff; text-align: center; margin: 30px 0 20px; }
        .welcome-text { text-align: center; color: #666; margin-bottom: 30px; padding: 0 20px; line-height: 1.5; }
        .join-page, .queue-status-page { padding: 0 30px 30px; }
        h1 { color: #333; margin-bottom: 30px; text-align: center; font-size: 24px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .required { color: #ff4757; }
        input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #4a90ff; }
        button { width: 100%; padding: 15px; background: #4a90ff; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
        button:hover:not(:disabled) { background: #357abd; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error-message, .success-message, .loading { padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; }
        .error-message { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .success-message { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c8; }
        .loading { background: #fff3e0; color: #f57c00; border: 1px solid #ffcc02; }
        .queue-status-page { display: none; text-align: center; }
        .circle-status { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; width: 200px; height: 200px; margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .token-number { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .position-text { font-size: 16px; line-height: 1.3; }
        .status-message { font-size: 14px; margin-top: 10px; opacity: 0.9; }
        .refresh-btn, .notification-btn, .quit-btn { margin: 10px 0; }
        .quit-btn { background: #ff4757; }
        .quit-btn:hover { background: #ff3742; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Join Page -->
        <div class="join-page" id="joinPage">
            <div class="brand-name">SmartQ</div>
            
            <div class="welcome-text">
                üéâ Welcome to SmartQ!<br>
                Join our virtual queue and get notified when it's your turn.
            </div>
            
            <h1>Join "SmartQ" Queue</h1>
            
            <div class="form-group">
                <label for="nameInput">Full Name <span class="required">*</span></label>
                <input type="text" id="nameInput" placeholder="Enter your full name" required>
            </div>
            
            <div class="form-group">
                <label for="mobileInput">Mobile Number <span class="required">*</span></label>
                <input type="tel" id="mobileInput" placeholder="Enter your mobile number" required>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            <div class="loading" id="loadingMessage">‚è≥ Joining queue...</div>
            
            <button onclick="joinQueue()" id="joinButton">Join Queue</button>
        </div>

        <!-- Queue Status Page -->
        <div class="queue-status-page" id="queueStatusPage">
            <div class="brand-name">SmartQ</div>
            
            <div class="success-message" style="display: block; margin-bottom: 20px;">
                ‚úÖ Successfully joined the queue!
            </div>
            
            <div class="circle-status">
                <div class="token-number">Your number is #<span id="tokenNum">001</span></div>
                <div class="position-text">You are <span id="queuePosition">1st</span><br>in the queue</div>
                <div class="status-message" id="statusMessage">‚Äî almost there!</div>
            </div>

            <button class="refresh-btn" onclick="refreshPosition()">Refresh Position</button>
            <button class="notification-btn" onclick="enableNotifications()">Enable Notifications</button>
            <button class="quit-btn" onclick="quitQueue()">Quit the Queue</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, getDocs, where, deleteDoc, onSnapshot } 
          from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDZhAk-MgGxpTE1fOdQvTvs_dNNla-u7wo",
          authDomain: "smartq-1ceb3.firebaseapp.com",
          projectId: "smartq-1ceb3",
          storageBucket: "smartq-1ceb3.firebasestorage.app",
          messagingSenderId: "779523540239",
          appId: "1:779523540239:web:618bb32f722976a91e6a7a",
          measurementId: "G-77DQW800QP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserToken = null;
        let currentUserDocId = null;

        // Show/Hide pages
        function showJoinPage() {
          document.getElementById('joinPage').style.display = 'block';
          document.getElementById('queueStatusPage').style.display = 'none';
        }

        function showQueueStatus() {
          document.getElementById('joinPage').style.display = 'none';
          document.getElementById('queueStatusPage').style.display = 'block';
        }

        // Helper to show/hide messages
        function showError(message) {
          const errorEl = document.getElementById('errorMessage');
          errorEl.textContent = message;
          errorEl.style.display = 'block';
          document.getElementById('successMessage').style.display = 'none';
        }

        function hideError() {
          document.getElementById('errorMessage').style.display = 'none';
        }

        function showSuccess(message) {
          const successEl = document.getElementById('successMessage');
          successEl.textContent = message;
          successEl.style.display = 'block';
          document.getElementById('errorMessage').style.display = 'none';
        }

        // Validate inputs
        function validateInput() {
          const name = document.getElementById('nameInput').value.trim();
          const mobile = document.getElementById('mobileInput').value.trim();

          if (!name) { 
            showError('Please enter your full name'); 
            return false; 
          }
          if (name.length < 2) { 
            showError('Name must be at least 2 characters'); 
            return false; 
          }
          if (!mobile) { 
            showError('Please enter your mobile number'); 
            return false; 
          }

          const mobileRegex = /^[6-9]\d{9}$/;
          if (!mobileRegex.test(mobile)) { 
            showError('Please enter a valid 10-digit mobile number'); 
            return false; 
          }

          return true;
        }

        // Initialize queue document if it doesn't exist
        async function initializeQueue() {
          try {
            const queueRef = doc(db, "smartq-queues", "queue-default");
            const queueSnap = await getDoc(queueRef);

            if (!queueSnap.exists()) {
              await setDoc(queueRef, {
                lastTokenNumber: 0,
                currentServing: 0,
                createdAt: new Date(),
                status: "active"
              });
            }
          } catch (error) {
            console.error("Error initializing queue:", error);
          }
        }

        // Calculate queue position
        async function calculatePosition(tokenNumber) {
          try {
            const queueRef = doc(db, "smartq-queues", "queue-default");
            const visitorsQuery = query(
              collection(queueRef, "visitors"), 
              where("status", "==", "waiting"),
              orderBy("tokenNumber")
            );
            const visitorDocs = await getDocs(visitorsQuery);
            
            let position = 0;
            visitorDocs.forEach((doc) => {
              const data = doc.data();
              if (data.tokenNumber <= tokenNumber) {
                position++;
              }
            });
            
            return position;
          } catch (error) {
            console.error("Error calculating position:", error);
            return 1;
          }
        }

        // Join Queue ‚Üí Save to Firestore
        async function joinQueue() {
          hideError();
          if (!validateInput()) return;

          const name = document.getElementById('nameInput').value.trim();
          const mobile = document.getElementById('mobileInput').value.trim();

          const joinBtn = document.getElementById('joinButton');
          const loadingMsg = document.getElementById('loadingMessage');
          
          joinBtn.disabled = true;
          joinBtn.textContent = 'Joining...';
          loadingMsg.style.display = 'block';

          try {
            // Initialize queue if needed
            await initializeQueue();

            // Check if user already in queue
            const queueRef = doc(db, "smartq-queues", "queue-default");
            const existingQuery = query(
              collection(queueRef, "visitors"),
              where("mobile", "==", mobile),
              where("status", "==", "waiting")
            );
            const existingDocs = await getDocs(existingQuery);

            if (!existingDocs.empty) {
              const existingUser = existingDocs.docs[0];
              const userData = existingUser.data();
              
              // Update current user info
              currentUserToken = userData.tokenNumber;
              currentUserDocId = existingUser.id;
              
              // Calculate and update position
              const position = await calculatePosition(userData.tokenNumber);
              updateQueueDisplay(userData.tokenNumber, position);
              
              showSuccess("Welcome back! You're already in the queue.");
              loadingMsg.style.display = 'none';
              showQueueStatus();
              return;
            }

            // Get current queue info
            const queueSnap = await getDoc(queueRef);
            if (!queueSnap.exists()) {
              throw new Error("Queue not found");
            }

            const lastToken = queueSnap.data().lastTokenNumber || 0;
            const newToken = lastToken + 1;

            // Add new visitor
            const visitorRef = await addDoc(collection(queueRef, "visitors"), {
              name,
              mobile,
              tokenNumber: newToken,
              status: "waiting",
              joinTime: new Date(),
              source: "online"
            });

            // Update queue's lastTokenNumber
            await updateDoc(queueRef, { lastTokenNumber: newToken });

            // Store current user info
            currentUserToken = newToken;
            currentUserDocId = visitorRef.id;

            // Calculate position
            const position = await calculatePosition(newToken);

            // Update UI
            updateQueueDisplay(newToken, position);

            // Reset form
            document.getElementById('nameInput').value = '';
            document.getElementById('mobileInput').value = '';

            loadingMsg.style.display = 'none';
            showQueueStatus();

          } catch (err) {
            console.error("Error joining queue:", err);
            showError("Failed to join queue. Please try again.");
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Queue';
            loadingMsg.style.display = 'none';
          }
        }

        // Update queue display
        function updateQueueDisplay(tokenNumber, position) {
          document.getElementById('tokenNum').textContent = tokenNumber.toString().padStart(3, '0');
          document.getElementById('queuePosition').textContent = getOrdinal(position);
          
          let statusMessage;
          if (position === 1) {
            statusMessage = "‚Äî you're next!";
          } else if (position <= 3) {
            statusMessage = "‚Äî almost there!";
          } else {
            const waitTime = (position - 1) * 3;
            statusMessage = `Estimated wait: ${waitTime} min`;
          }
          document.getElementById('statusMessage').textContent = statusMessage;
        }

        // Refresh position
        async function refreshPosition() {
          if (!currentUserToken) return;

          try {
            const position = await calculatePosition(currentUserToken);
            updateQueueDisplay(currentUserToken, position);
            showSuccess("Position updated!");
            
            setTimeout(() => {
              document.getElementById('successMessage').style.display = 'none';
            }, 2000);

          } catch (error) {
            console.error("Error refreshing position:", error);
            showError("Failed to refresh position.");
          }
        }

        // Get ordinal number
        function getOrdinal(num) {
          const suffix = ["th", "st", "nd", "rd"];
          const v = num % 100;
          return num + (suffix[(v - 20) % 10] || suffix[v] || suffix[0]);
        }

        // Quit Queue
        async function quitQueue() {
          if (!confirm("Are you sure you want to quit the queue?")) return;

          try {
            if (currentUserDocId) {
              const queueRef = doc(db, "smartq-queues", "queue-default");
              const visitorRef = doc(collection(queueRef, "visitors"), currentUserDocId);
              await deleteDoc(visitorRef);
            }

            // Reset current user info
            currentUserToken = null;
            currentUserDocId = null;

            // Reset form
            document.getElementById('nameInput').value = '';
            document.getElementById('mobileInput').value = '';
            document.getElementById('joinButton').disabled = false;
            document.getElementById('joinButton').textContent = 'Join Queue';

            showJoinPage();
            showSuccess("Successfully left the queue.");

          } catch (error) {
            console.error("Error quitting queue:", error);
            showError("Failed to quit queue.");
          }
        }

        // Enable notifications
        function enableNotifications() {
          if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                showSuccess("Notifications enabled!");
                new Notification('SmartQ', {
                  body: 'You will be notified when it\'s your turn!',
                  icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234a90ff"/></svg>'
                });
              } else {
                showError("Please allow notifications in your browser.");
              }
            });
          } else {
            showError("Your browser doesn't support notifications.");
          }
        }

        // Add Enter key support
        document.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const activeElement = document.activeElement;
            if (activeElement.id === 'nameInput' || activeElement.id === 'mobileInput') {
              joinQueue();
            }
          }
        });

        // Auto-format mobile number
        document.getElementById('mobileInput').addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 10) {
            value = value.slice(0, 10);
          }
          e.target.value = value;
        });

        // Clear error on input
        document.getElementById('nameInput').addEventListener('input', hideError);
        document.getElementById('mobileInput').addEventListener('input', hideError);

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
          showJoinPage();
        });

        // Make functions available globally
        window.showJoinPage = showJoinPage;
        window.showQueueStatus = showQueueStatus;
        window.joinQueue = joinQueue;
        window.quitQueue = quitQueue;
        window.enableNotifications = enableNotifications;
        window.refreshPosition = refreshPosition;
    </script>
</body>
</html>
